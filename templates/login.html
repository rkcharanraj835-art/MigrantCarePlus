<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MigrantCare+ | Login</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
  .error-msg {
    color: red;
    font-weight: bold;
    margin: 5px 0;
  }
  .success-msg {
    color: green;
    font-weight: bold;
    margin: 5px 0;
  }
</style>
</head>
<body>
  <div class="auth-container">
    <h2>Login</h2>

    <form id="login-form" method="post">
      <div class="input-group">
        <label for="member-id">Member-ID</label>
        <!-- ✅ auto-filled from ?member_id=XYZ -->
        <input type="text" id="member-id" name="member_id"
               placeholder="Enter your Member-ID"
               value="{{ request.args.get('member_id','') }}" required>
      </div>

      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" name="password" placeholder="Enter your password" required>
      </div>

      <!-- Login status message -->
      <p id="login-msg"></p>

      <button type="submit" class="btn">Login</button>
    </form>

    <div class="auth-links">
      <a href="{{ url_for('forgot') }}?member_id={{ request.args.get('member_id','') }}" id="forgot-link">
        Forgot Password?
      </a> | 
      <a href="{{ url_for('create_account') }}">Create Account</a>
    </div>

    <div class="auth-links">
      <a href="{{ url_for('home') }}">← Back to Home</a>
    </div>
  </div>

<script>
const loginForm = document.getElementById("login-form");
const loginMsg = document.getElementById("login-msg");
const memberInput = document.getElementById("member-id");
const forgotLink = document.getElementById("forgot-link");

// Update Forgot Password link dynamically
memberInput.addEventListener('input', () => {
  const memberId = memberInput.value.trim();
  forgotLink.href = "{{ url_for('forgot') }}?member_id=" + encodeURIComponent(memberId);
});

// AJAX Login handler
loginForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  loginMsg.textContent = "";

  const member_id = memberInput.value.trim();
  const password = document.getElementById("password").value;

  try {
    const response = await fetch("{{ url_for('login') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ member_id, password })
    });

    const data = await response.json();

    if (data.success) {
      loginMsg.className = "success-msg";
      loginMsg.textContent = "✅ Login successful. Redirecting...";
      setTimeout(() => {
        window.location.href = "{{ url_for('profile') }}";
      }, 800);
    } else {
      loginMsg.className = "error-msg";
      loginMsg.textContent = "❌ " + data.message;
    }
  } catch (err) {
    console.error("Login failed:", err);
    loginMsg.className = "error-msg";
    loginMsg.textContent = "❌ Server error. Try again.";
  }
});
</script>
</body>
</html>